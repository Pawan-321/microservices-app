name: Sock Shop CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  AWS_REGION: us-east-1

jobs:
  # Job 1: Lint and validate Kubernetes manifests
  validate-manifests:
    name: Validate Kubernetes Manifests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'
    
    - name: Validate YAML files
      run: |
        echo "Validating Kubernetes manifests..."
        for file in deploy/kubernetes/manifests/*.yaml; do
          if [ -f "$file" ]; then
            echo "Checking $file"
            kubectl apply --dry-run=client -f "$file" || exit 1
          fi
        done
        echo "✅ All manifests are valid"

  # Job 2: Security scanning
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'
        exit-code: '0'  # Don't fail the build on vulnerabilities
        severity: 'CRITICAL,HIGH'

  # Job 3: Deploy to Kubernetes (only on main branch)
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: [validate-manifests, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'
    
    - name: Configure kubectl
      run: |
        mkdir -p ~/.kube
        echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
        chmod 600 ~/.kube/config
    
    - name: Verify cluster connection
      run: |
        echo "Testing connection to Kubernetes cluster..."
        kubectl get nodes
        kubectl get namespaces
    
    - name: Deploy Sock Shop application
      run: |
        echo "Deploying Sock Shop to Kubernetes..."
        kubectl apply -f deploy/kubernetes/manifests/
        echo "✅ Deployment applied successfully"
    
    - name: Wait for deployment to stabilize
      run: |
        echo "Waiting for pods to be ready..."
        kubectl wait --for=condition=ready pod -l name=front-end -n sock-shop --timeout=300s || true
        kubectl wait --for=condition=ready pod -l name=catalogue -n sock-shop --timeout=300s || true
        kubectl wait --for=condition=ready pod -l name=carts -n sock-shop --timeout=300s || true
    
    - name: Check deployment status
      run: |
        echo "=== Deployment Status ==="
        kubectl get pods -n sock-shop
        echo ""
        echo "=== Services ==="
        kubectl get svc -n sock-shop
        echo ""
        echo "=== Front-end URL ==="
        kubectl get svc front-end -n sock-shop -o jsonpath='{.spec.ports[0].nodePort}' && echo
    
    - name: Verify application health
      run: |
        echo "Checking application health..."
        HEALTHY=$(kubectl get pods -n sock-shop --field-selector=status.phase=Running --no-headers | wc -l)
        TOTAL=$(kubectl get pods -n sock-shop --no-headers | wc -l)
        echo "Healthy pods: $HEALTHY/$TOTAL"
        
        if [ "$HEALTHY" -lt "$((TOTAL * 80 / 100))" ]; then
          echo "⚠️ Warning: Less than 80% of pods are healthy"
          kubectl get pods -n sock-shop
          exit 1
        else
          echo "✅ Deployment successful! $HEALTHY/$TOTAL pods are healthy"
        fi

  # Job 4: Deploy monitoring (only on main branch, optional)
  deploy-monitoring:
    name: Deploy Monitoring Stack
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'
    
    - name: Configure kubectl
      run: |
        mkdir -p ~/.kube
        echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
        chmod 600 ~/.kube/config
    
    - name: Check if monitoring namespace exists
      id: check-monitoring
      run: |
        if kubectl get namespace monitoring &> /dev/null; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "✅ Monitoring namespace already exists"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "ℹ️ Monitoring namespace does not exist"
        fi
    
    - name: Deploy monitoring stack
      if: steps.check-monitoring.outputs.exists == 'false'
      run: |
        echo "Deploying monitoring stack..."
        kubectl apply -f deploy/kubernetes/manifests-monitoring/ || echo "⚠️ Monitoring deployment skipped or failed"
    
    - name: Check monitoring status
      run: |
        if kubectl get namespace monitoring &> /dev/null; then
          echo "=== Monitoring Pods ==="
          kubectl get pods -n monitoring
        else
          echo "ℹ️ Monitoring namespace not found - skipping status check"
        fi

  # Job 5: Notification (optional - runs always)
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [deploy, deploy-monitoring]
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
    - name: Deployment Summary
      run: |
        echo "==================================="
        echo "Deployment Pipeline Summary"
        echo "==================================="
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo "Triggered by: ${{ github.actor }}"
        echo "Status: ${{ job.status }}"
        echo "==================================="
        
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "✅ Application deployment: SUCCESS"
        else
          echo "❌ Application deployment: FAILED"
        fi
        
        if [ "${{ needs.deploy-monitoring.result }}" == "success" ]; then
          echo "✅ Monitoring deployment: SUCCESS"
        elif [ "${{ needs.deploy-monitoring.result }}" == "skipped" ]; then
          echo "⏭️ Monitoring deployment: SKIPPED"
        else
          echo "❌ Monitoring deployment: FAILED"
        fi
