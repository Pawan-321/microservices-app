name: Sock Shop CI/CD Pipeline (Self-Hosted)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  AWS_REGION: us-east-1

jobs:
  # Job 1: Lint and validate Kubernetes manifests
  validate-manifests:
    name: Validate Kubernetes Manifests
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Validate YAML syntax
      run: |
        echo "Validating Kubernetes manifests..."
        
        # Check if yq is installed, if not install it
        if ! command -v yq &> /dev/null; then
          echo "Installing yq..."
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
        fi
        
        # Validate YAML syntax
        for file in deploy/kubernetes/manifests/*.yaml; do
          if [ -f "$file" ]; then
            echo "‚úì Checking $file"
            yq eval '.' "$file" > /dev/null || exit 1
          fi
        done
        echo "‚úÖ All YAML files have valid syntax"

  # Job 2: Security scanning
  security-scan:
    name: Security Scan
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Run Trivy vulnerability scanner
      run: |
        # Check if trivy is installed
        if ! command -v trivy &> /dev/null; then
          echo "Installing Trivy..."
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy -y
        fi
        
        echo "Running Trivy security scan..."
        trivy fs --severity HIGH,CRITICAL --exit-code 0 . || echo "‚ö†Ô∏è Vulnerabilities found but continuing..."

  # Job 3: Deploy to Kubernetes (only on main branch)
  deploy:
    name: Deploy to Kubernetes
    runs-on: self-hosted
    needs: [validate-manifests, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Verify cluster connection
      run: |
        echo "Testing connection to Kubernetes cluster..."
        kubectl get nodes
        kubectl get namespaces
    
    - name: Deploy Sock Shop application
      run: |
        echo "Deploying Sock Shop to Kubernetes..."
        kubectl apply -f deploy/kubernetes/manifests/
        echo "‚úÖ Deployment applied successfully"
    
    - name: Wait for deployment to stabilize
      run: |
        echo "Waiting for pods to be ready..."
        kubectl wait --for=condition=ready pod -l name=front-end -n sock-shop --timeout=300s || true
        kubectl wait --for=condition=ready pod -l name=catalogue -n sock-shop --timeout=300s || true
        kubectl wait --for=condition=ready pod -l name=carts -n sock-shop --timeout=300s || true
        
        echo "Waiting a bit more for all services to stabilize..."
        sleep 30
    
    - name: Check deployment status
      run: |
        echo "=== Deployment Status ==="
        kubectl get pods -n sock-shop
        echo ""
        echo "=== Services ==="
        kubectl get svc -n sock-shop
        echo ""
        echo "=== Front-end Service Details ==="
        kubectl get svc front-end -n sock-shop
        
        # Get NodePort
        NODE_PORT=$(kubectl get svc front-end -n sock-shop -o jsonpath='{.spec.ports[0].nodePort}')
        PUBLIC_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)
        echo ""
        echo "üåê Application URL: http://$PUBLIC_IP:$NODE_PORT"
    
    - name: Verify application health
      run: |
        echo "Checking application health..."
        HEALTHY=$(kubectl get pods -n sock-shop --field-selector=status.phase=Running --no-headers | wc -l)
        TOTAL=$(kubectl get pods -n sock-shop --no-headers | wc -l)
        echo "Healthy pods: $HEALTHY/$TOTAL"
        
        if [ "$HEALTHY" -lt "$((TOTAL * 70 / 100))" ]; then
          echo "‚ö†Ô∏è Warning: Less than 70% of pods are healthy"
          kubectl get pods -n sock-shop
          echo "Checking pod events..."
          kubectl get events -n sock-shop --sort-by='.lastTimestamp' | tail -20
        else
          echo "‚úÖ Deployment successful! $HEALTHY/$TOTAL pods are healthy"
        fi

  # Job 4: Deploy monitoring (only on main branch, optional)
  deploy-monitoring:
    name: Verify Monitoring Stack
    runs-on: self-hosted
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check monitoring namespace
      id: check-monitoring
      run: |
        if kubectl get namespace monitoring &> /dev/null; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Monitoring namespace already exists"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "‚ÑπÔ∏è Monitoring namespace does not exist"
        fi
    
    - name: Check monitoring status
      run: |
        if kubectl get namespace monitoring &> /dev/null; then
          echo "=== Monitoring Pods ==="
          kubectl get pods -n monitoring
          echo ""
          echo "=== Monitoring Services ==="
          kubectl get svc -n monitoring
          
          # Get Grafana info
          if kubectl get svc prometheus-grafana -n monitoring &> /dev/null; then
            echo ""
            echo "üìä Grafana is available"
            echo "Get password with: kubectl get secret -n monitoring prometheus-grafana -o jsonpath=\"{.data.admin-password}\" | base64 --decode"
          fi
          
          # Get Prometheus info
          if kubectl get svc prometheus-kube-prometheus-prometheus -n monitoring &> /dev/null; then
            echo "üìà Prometheus is available"
          fi
        else
          echo "‚ÑπÔ∏è Monitoring namespace not found"
          echo "To install monitoring, run:"
          echo "helm repo add prometheus-community https://prometheus-community.github.io/helm-charts"
          echo "helm install prometheus prometheus-community/kube-prometheus-stack -n monitoring --create-namespace"
        fi

  # Job 5: Notification and Summary
  notify:
    name: Deployment Summary
    runs-on: self-hosted
    needs: [deploy, deploy-monitoring]
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
    - name: Generate Deployment Report
      run: |
        echo "============================================"
        echo "    üöÄ DEPLOYMENT SUMMARY"
        echo "============================================"
        echo ""
        echo "üì¶ Repository: ${{ github.repository }}"
        echo "üåø Branch: ${{ github.ref_name }}"
        echo "üìù Commit: ${{ github.sha }}"
        echo "üë§ Triggered by: ${{ github.actor }}"
        echo "‚è∞ Time: $(date)"
        echo ""
        echo "============================================"
        echo "    üìä JOB RESULTS"
        echo "============================================"
        
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "‚úÖ Application deployment: SUCCESS"
        else
          echo "‚ùå Application deployment: FAILED"
        fi
        
        if [ "${{ needs.deploy-monitoring.result }}" == "success" ]; then
          echo "‚úÖ Monitoring verification: SUCCESS"
        elif [ "${{ needs.deploy-monitoring.result }}" == "skipped" ]; then
          echo "‚è≠Ô∏è  Monitoring verification: SKIPPED"
        else
          echo "‚ùå Monitoring verification: FAILED"
        fi
        
        echo ""
        echo "============================================"
        echo "    üîó ACCESS INFORMATION"
        echo "============================================"
        
        # Get application URL
        if kubectl get svc front-end -n sock-shop &> /dev/null; then
          NODE_PORT=$(kubectl get svc front-end -n sock-shop -o jsonpath='{.spec.ports[0].nodePort}')
          PUBLIC_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)
          echo "üåê Application: http://$PUBLIC_IP:$NODE_PORT"
        fi
        
        echo ""
        echo "============================================"
        
    - name: Cleanup
      if: always()
      run: |
        echo "Cleaning up workspace..."
        # Don't delete the entire workspace on self-hosted runner
        # Just clean specific build artifacts if needed
        echo "‚úÖ Cleanup complete"
